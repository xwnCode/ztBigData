<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../TLMessage/demo/css/default.css" rel="stylesheet" type="text/css" />
    <link href="../TLMessage/demo/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../TLMessage/demo/js/jquery.min.js" type="text/javascript"></script>
    <script src="../TLMessage/demo/js/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../TLMessage/demo/js/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <link href="../TLMessage/demo/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        .Title
        {
            font-weight: bold;
            font-size: 14px;
            padding-left: 5px;
        }
        .Head
        {
            font-weight: bold;
            font-size: 13px;
            padding-left: 5px;
        }
        .tdLeft
        {
            height: 37px;
            background: #F5FAFA;
            border-right: 1px solid #C1DAD7;
            font-size: 12px;
            color: #4f6b72;
            font-weight: bold;
            line-height: 30px;
            text-align: left;
            padding-left: 10px;
        }
        .tdleft
        {
            width: 35px;
            border-right: 1px solid #C1DAD7;
            border-bottom: 1px solid #C1DAD7;
            background: #F5FAFA;
            font-size: 12px;
            color: #4f6b72;
            font-weight: bold;
            line-height: 25px;
            text-align: right;
            padding-right: 10px;
        }
        .tdright
        {
            width: 170px;
            margin-left: 10px;
            border-right: 1px solid #C1DAD7;
            border-bottom: 1px solid #C1DAD7;
            background: #fff;
            font-size: 12px;
            color: #28474F;
            line-height: 25px;
            text-align: left;
            padding-left: 10px;
        }
        
        #divPlanAdd
        {
            top: 5px;
            right: 10px;
            position: absolute;
            z-index: 9999;
        }
        #divPlanView
        {
            top: 5px;
            right: 10px;
            position: absolute;
            z-index: 9999;
        }
    </style>
</head>
<body style="font-size: 12px;">
    <div id="yhlb" class="easyui-layout" style="width: 100%; height: 760px; background-color: #ffffff;">
        <table id="YearPlanTypeData" class="easyui-datagrid" data-options="
				method:'get',
				onClickCell: onClickCell
			">
            <thead>
            <h3 style="text-align: center;">
                隐患列表录入页面</h3>
                <tr>
                    <th data-options="field:'SSGS',editor:'text',width: 90">
                        所属公司
                    </th>
                    <th data-options="field:'XMB',editor:'text',width: 90">
                        项目部
                    </th>
                    <th data-options="field:'YHBM',editor:'text',width: 90">
                        隐患编码
                    </th>
                    <th data-options="field:'ZY',editor:'text',width: 90">
                        专业
                    </th>
                    <th data-options="field:'PCLB',editor:'text',width: 90">
                        排查类别
                    </th>
                    <th data-options="field:'PCXM',editor:'text',width: 90">
                        排查项目
                    </th>
                    <th data-options="field:'PCNRQ',editor:'text',width: 90">
                        排查前内容
                    </th>
                    <th data-options="field:'PCNRH',editor:'text',width: 90">
                        问题描述
                    </th>
                    <th data-options="field:'PCR',editor:'text',width: 90">
                        排查人
                    </th>
                    <th data-options="field:'YHJB',editor:'text',width: 90">
                        隐患级别
                    </th>
                    <th data-options="field:'ZG',editor:'text',width: 90">
                        是否整改
                    </th>
                    <th data-options="field:'BZ',editor:'text',width: 90">
                        备注
                    </th>
                </tr>
            </thead>
        </table>
        <div id="divGroupYearPlanFooter" style="width: 100%; height: auto;">
            <a class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="append()">
                新增</a> <a class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true"
                    onclick="removeit()">删除</a> <a class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true"
                        onclick="getChanges()">保存</a>
        </div>
        <div>
            <tr>
                <td class="tdleft">
                    排查前图片:
                </td>
                <td colspan="6" class="tdright">
                    <input name="icon" id="pfile" type="file" value="" onchange="show(this)" />
                    <img src="" id="pic" height="100px" /><br />
                </td>
            </tr>
            <tr>
                <td class="tdleft" colspan="6" style="height: 5px">
                </td>
            </tr>
        </div>
        <div>
            <tr>
                <td class="tdleft">
                    排查后图片:
                </td>
                <td colspan="6" class="tdright">
                    <input name="icon1" id="File1" type="file" value="" onchange="shows(this)" />
                    <img src="" id="Img1" height="100px" /><br />
                </td>
            </tr>
            <tr>
                <td class="tdleft" colspan="6" style="height: 5px">
                </td>
            </tr>
        </div>
        <div>
        <tr>
            <ul id="img1" style="height: 10% width: 10%;">
            </ul></tr>
            <tr>
            <ul id="img2" style="height: 10%; width: 10%;">
            </ul></tr>
        </div>
    </div>
    <script type="text/javascript">
    $(function () {
    Detail();
    })


    function Detail() {

        var html3 = "";
        var html4 = "";
        $.ajax({
            url: '../BigDataAnQuan/GetPCLB.ashx',
            async: false,
            type: 'post',
            data: {},
            dataType: 'json',
            success: function (data) {
                debugger;
                var datas = JSON.stringify(data[0]);
                var src1 = 'data:image/png;base64,' + arrayBufferToBase64(data[0].PCQ); //转换字符串 
                html3 += "<li class='carousel-item'><img src='" + src1 + "' style='width:100px;' /><div style='position: absolute; bottom: -35%; width:100%;text-align:center; '></div></li>";
                var src2 = 'data:image/png;base64,' + arrayBufferToBase64(data[0].PCH); //转换字符串 
                html4 += "<li class='carousel-item'><img src='" + src2 + "' style='width:100px;'/><div style='position: absolute; bottom: -35%; width:100%;text-align:center; '></div></li>";
                //alert(html1);
                //alert(html2);
                //        $("#img1").empty();
                //        $("#img2").empty();
                //$("#tabpage2").empty();
                $("#img1").append(html3);
                $("#img2").append(html4);
            },
            error: function (data) {
                return "";
            }
        });
    }

 function arrayBufferToBase64(buffer) {
    var binary = '';
    var bytes = new Uint8Array(buffer);
    var len = bytes.byteLength;
    for (var i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}



        function show(f) {
            debugger;
            var rd = new FileReader(); //创建文件读取对象
            var files = f.files[0]; //获取file组件中的文件
            rd.readAsDataURL(files); //文件读取装换为base64类型
            rd.onloadend = function (e) {
                //alert(this.result);
                //加载完毕之后获取结果赋值给img
                document.getElementById("pic").src = this.result;
            }
        }

        function shows(f) {
            debugger;
            var rd = new FileReader(); //创建文件读取对象
            var files = f.files[0]; //获取file组件中的文件
            rd.readAsDataURL(files); //文件读取装换为base64类型
            rd.onloadend = function (e) {
                //alert(this.result);
                //加载完毕之后获取结果赋值给img
                document.getElementById("Img1").src = this.result;
            }
        }


        $('#YearPlanTypeData').datagrid({
            iconCls: 'icon-edit', //图标 
            singleSelect: true,
            nowrap: false,
            striped: true,
            border: true,
            collapsible: false, //是否可折叠的               
            url: '../BigDataAnQuan/NewGetYhlb.ashx',
            queryParams: {
                Opreate: 'GetList',
                cs: Math.random()
            },
            remoteSort: false,
            toolbar: divGroupYearPlanFooter,
            //pagination: true,
            rownumbers: true, //行号                  
            frozenColumns: [[
                { field: 'ck', checkbox: true }
            ]]
        });

        $.extend($.fn.datagrid.methods, {
            editCell: function (jq, param) {

                //$('#YearPlan_GroupData').datagrid('unselectAll');

                return jq.each(function () {
                    var opts = $(this).datagrid('options');
                    var fields = $(this).datagrid('getColumnFields', true).concat($(this).datagrid('getColumnFields'));
                    for (var i = 0; i < fields.length; i++) {
                        var col = $(this).datagrid('getColumnOption', fields[i]);
                        col.editor1 = col.editor;
                        if (fields[i] != param.field) {
                            col.editor = null;
                        }
                    }
                    $(this).datagrid('beginEdit', param.index);
                    for (var i = 0; i < fields.length; i++) {
                        var col = $(this).datagrid('getColumnOption', fields[i]);
                        col.editor = col.editor1;
                    }
                });
            }
        });

        function onClickCell(index, field) {

            if (endEditing()) {
                $('#YearPlanTypeData').datagrid('selectRow', index)
						.datagrid('editCell', { index: index, field: field });
                editIndex = index;
            }
        }

        function getChanges() {
            debugger;
            endEditing();
            var row = $('#YearPlanTypeData').datagrid('getSelected');
            var rows = $('#YearPlanTypeData').datagrid('getChanges');
            var files1 = $("#pfile").get(0).files;
            var files2 = $("#File1").get(0).files;
            var pic1 = document.getElementById("pic").src;
            var pic2 = document.getElementById("Img1").src;
            var strJson = JSON.stringify(rows);

            $('#yhlb').datagrid({
//                contentType: false,
//                // 告诉jQuery不要去设置Content-Type请求头
//                processData: false,
//                // 告诉jQuery不要去处理发送的数据
                url: '../BigDataAnQuan/NewGetYhlb.ashx',
               
                queryParams: {
                    Opreate: 'Add',
                    dataObject: strJson,
                    Id: row.Id,
                    objkl: '' + Math.random() + '',
                    pic1: pic1, 
                    pic2: pic2
                },
                remoteSort: false
            });
            alert("保存成功");
            window.location.reload();
        }
        function append() {
            if (endEditing()) {
                $('#YearPlanTypeData').datagrid('appendRow', { status: 'P' });
                editIndex = $('#YearPlanTypeData').datagrid('getRows').length - 1;
                $('#YearPlanTypeData').datagrid('selectRow', editIndex)
						.datagrid('beginEdit', editIndex);
            }
        }

        function removeit() {
            var row = $('#YearPlanTypeData').datagrid('getSelected');
            if (row) {
                if (row.Id != null) {
                    //若Id存在则删除数据库记录
                    $('#YearPlanTypeData').datagrid({
                        url: '../BigDataAnQuan/NewGetYhlb.ashx',
                        queryParams: {
                            Opreate: 'Delete',
                            Id: row.Id,
                            objkl: '' + Math.random() + ''
                        },
                        remoteSort: false
                    });

                    $('#YearPlanTypeData').datagrid('cancelEdit', editIndex)
					.datagrid('deleteRow', editIndex);
                    window.location.reload();
                }
                else {
                    $('#YearPlanTypeData').datagrid('cancelEdit', editIndex)
					.datagrid('deleteRow', editIndex);
                    window.location.reload();
                }
                editIndex = undefined;
                window.location.reload();
            }
            else {
                alert("请勾选列表后再进行删除！");
                return false;
            }
            window.location.reload();
        }
        var editIndex = undefined;
        function endEditing() {
            if (editIndex == undefined) { return true }
            if ($('#YearPlanTypeData').datagrid('validateRow', editIndex)) {
                $('#YearPlanTypeData').datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }
        
    </script>
</body>
</html>
