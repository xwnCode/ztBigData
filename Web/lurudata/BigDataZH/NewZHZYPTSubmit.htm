<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../TLMessage/demo/css/default.css" rel="stylesheet" type="text/css" />
    <link href="../TLMessage/demo/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../TLMessage/demo/js/jquery.min.js" type="text/javascript"></script>
    <script src="../TLMessage/demo/js/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../TLMessage/demo/js/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <link href="../TLMessage/demo/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        .Title
        {
            font-weight: bold;
            font-size: 14px;
            padding-left: 5px;
        }
        .Head
        {
            font-weight: bold;
            font-size: 13px;
            padding-left: 5px;
        }
        .tdLeft
        {
            height: 37px;
            background: #F5FAFA;
            border-right: 1px solid #C1DAD7;
            font-size: 12px;
            color: #4f6b72;
            font-weight: bold;
            line-height: 30px;
            text-align: left;
            padding-left: 10px;
        }
      
        #divPlanAdd
        {
            top: 5px;
            right: 10px;
            position: absolute;
            z-index: 9999;
        }
        #divPlanView
        {
            top: 5px;
            right: 10px;
            position: absolute;
            z-index: 9999;
        }
      
    </style>
</head>
<body style="font-size: 12px;">
    <div class="easyui-layout" style="width: 100%; height:470px; background-color: #ffffff;">
        <table id="YearPlanTypeData" class="easyui-datagrid" data-options="
				method:'get',
				onClickCell: onClickCell
			">
            <thead>
            <h3 style="text-align: center;">
                综合作业平台下发任务页面</h3>
               <th data-options="field:'Worktype',width: 120,editor:{type:'combobox',options:{data:[{'value':'钻孔作业','text':'钻孔作业'}],valueField:'value',textField:'text'}}">
                作业类型
                </th>
                <th data-options="field:'Qujian',editor:'text',width: 120">
                    区间/站
                </th>
                <th data-options="field:'Ganhao',editor:'text',width: 120">
                    杆号
                </th>
                <th data-options="field:'Direction',editor:'text',width: 120">
                    线别
                </th>
                <th data-options="field:'Site',editor:'numberbox',width: 120">
                    里程/m
                </th>
                <th data-options="field:'Coordinate',editor:'numberbox',width: 120">
                    坐标/m
                </th>
                <th data-options="field:'Type',editor:'text',width: 120">
                    规格型号
                </th>
                <th data-options="field:'Ks',editor:'numberbox',width: 120">
                    孔深/mm
                </th>
                <th data-options="field:'Kj',editor:'numberbox',width: 120">
                    孔径/mm
                </th>
                <th data-options="field:'Kjj',editor:'numberbox',width: 120">
                    孔间距/mm
                </th>
                <th data-options="field:'Kzquantity',editor:'numberbox',width: 120">
                    数量/套
                </th>
                </tr>
            </thead>
        </table>
        <div id="divGroupYearPlanFooter" style="width: 100%; height: auto; ">
            <a  class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true"
                onclick="append()">添加</a> <a class="easyui-linkbutton"
                    data-options="iconCls:'icon-remove',plain:true" onclick="removeit()">删除</a>
            <a  class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true"
                onclick="getChanges()">下发</a>
        </div>
    </div>
    
    <script type="text/javascript">
        
        $('#YearPlanTypeData').datagrid({
            iconCls: 'icon-edit', //图标 
            singleSelect: true,
            nowrap: false,
            striped: true,
            border: true,
            collapsible: false, //是否可折叠的               
            url: '../BigDataZH/NewGetZHZYPTSubmit.ashx',
            queryParams: {
                Opreate: 'GetList',
                cs: Math.random()
            },
            remoteSort: false,
            toolbar: divGroupYearPlanFooter,
            //pagination: true,
            rownumbers: true, //行号                  
            frozenColumns: [[
                { field: 'ck', checkbox: true }
            ]]
        });

        $.extend($.fn.datagrid.methods, {
            editCell: function (jq, param) {

                //$('#YearPlan_GroupData').datagrid('unselectAll');

                return jq.each(function () {
                    var opts = $(this).datagrid('options');
                    var fields = $(this).datagrid('getColumnFields', true).concat($(this).datagrid('getColumnFields'));
                    for (var i = 0; i < fields.length; i++) {
                        var col = $(this).datagrid('getColumnOption', fields[i]);
                        col.editor1 = col.editor;
                        if (fields[i] != param.field) {
                            col.editor = null;
                        }
                    }
                    $(this).datagrid('beginEdit', param.index);
                    for (var i = 0; i < fields.length; i++) {
                        var col = $(this).datagrid('getColumnOption', fields[i]);
                        col.editor = col.editor1;
                    }
                });
            }
        });

        function onClickCell(index, field) {

            if (endEditing()) {
                $('#YearPlanTypeData').datagrid('selectRow', index)
						.datagrid('editCell', { index: index, field: field });
                editIndex = index;
            }
        }

        function getChanges() {
            endEditing();

            var rows = $('#YearPlanTypeData').datagrid('getChanges');
            var strJson = JSON.stringify(rows);

            $('#YearPlanTypeData').datagrid({
                url: '../BigDataZH/NewGetZHZYPTSubmit.ashx',
                queryParams: {
                    Opreate: 'Add',
                    dataObject: strJson,
                    Id: rows.Id,
                    objkl: '' + Math.random() + ''
                },
                remoteSort: false
            });
            alert("下发成功");
        }
        function append() {
            if (endEditing()) {
                $('#YearPlanTypeData').datagrid('appendRow', { status: 'P' });
                editIndex = $('#YearPlanTypeData').datagrid('getRows').length - 1;
                $('#YearPlanTypeData').datagrid('selectRow', editIndex)
						.datagrid('beginEdit', editIndex);
            }
        }

        function removeit() {
            var row = $('#YearPlanTypeData').datagrid('getSelected');
            if (row) {
                if (row.Id != null) {
                    //若Id存在则删除数据库记录
                    $('#YearPlanTypeData').datagrid({
                        url: '../BigDataZH/NewGetZHZYPTSubmit.ashx',
                        queryParams: {
                            Opreate: 'Delete',
                            Id: row.Id,
                            objkl: '' + Math.random() + ''
                        },
                        remoteSort: false
                    });

                    $('#YearPlanTypeData').datagrid('cancelEdit', editIndex)
					.datagrid('deleteRow', editIndex);
                }
                else {
                    $('#YearPlanTypeData').datagrid('cancelEdit', editIndex)
					.datagrid('deleteRow', editIndex);
                }
                editIndex = undefined;
            }
            else {
                alert("请勾选列表后再进行删除！");
                return false;
            }
        }
        var editIndex = undefined;
        function endEditing() {
            if (editIndex == undefined) { return true }
            if ($('#YearPlanTypeData').datagrid('validateRow', editIndex)) {
                $('#YearPlanTypeData').datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }
        
    </script>
</body>
</html>
