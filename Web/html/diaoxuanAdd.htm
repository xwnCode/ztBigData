<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="easyui/easyui.css" rel="stylesheet" type="text/css" />
    <link href="easyui/icon.css" rel="stylesheet" type="text/css" />
    <script src="easyui/jquery.min.js" type="text/javascript"></script>
    <script src="easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="easyui/easyui-lang-zh_CN.js" type="text/javascript"></script>
</head>
<body>
    <div id="divToolFriendLink">
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save'"
            onclick="Add()">下发</a>
    </div>
    <table id="tbFriendLink">
        <thead>
            <tr>
                <th field="ck" checkbox="true">
                </th>
<!--                <th data-options="field:'DateofData',formatter:date">
                    数据日期
                </th>-->
                <th data-options="field:'mdName',width: 120">
                    锚段名称
                </th>
                <th data-options="field:'kdNo',width: 120">
                    跨段编号
                </th>
                <th data-options="field:'kj',width: 120">
                    跨距
                </th>
                <th data-options="field:'type',width: 120">
                    项目类型
                </th>
                <th data-options="field:'dd1',width: 60">
                    弹吊1
                </th>
                <th data-options="field:'dd3',width: 60">
                    弹吊3
                </th>
                <th data-options="field:'dx1',width: 60">
                    吊弦1
                </th>
                <th data-options="field:'dx2',width: 60">
                    吊弦2
                </th>
                <th data-options="field:'dx3',width: 60">
                    吊弦3
                </th>
                <th data-options="field:'dx4',width: 60">
                    吊弦4
                </th>
                <th data-options="field:'dx5',width: 60">
                    吊弦5
                </th>
                <th data-options="field:'dx6',width: 60">
                    吊弦6
                </th>
                <th data-options="field:'dx7',width: 60">
                    吊弦7
                </th>
                <th data-options="field:'dx8',width: 60">
                    吊弦8
                </th>
                <th data-options="field:'dx9',width: 60">
                    吊弦9
                </th>
                <th data-options="field:'dx10',width: 60">
                    吊弦10
                </th>
                <th data-options="field:'dx11',width: 60">
                    吊弦11
                </th>
                <th data-options="field:'dd4',width: 60">
                    弹吊4
                </th>
                <th data-options="field:'dd2',width: 60">
                    弹吊2
                </th>
                <th data-options="field:'mjj',width: 60">
                    末间距
                </th>
                <th data-options="field:'zm',width: 60">
                    中锚
                </th>
                <th data-options="field:'qsd',width: 60">
                    前索端
                </th>
                <th data-options="field:'hsd',width: 60">
                    后索端
                </th>
            </tr>
        </thead>
    </table>
    <script type="text/javascript">
        $('#tbFriendLink').datagrid({
            iconCls: 'icon-edit', //图标 
            singleSelect: false, //是否单选 
            toolbar: '#divToolFriendLink',
            nowrap: false,
            striped: true,
            border: true,
            collapsible: false, //是否可折叠的               
            url: '../databydx/GetProDataByBIMdx.ashx',
            remoteSort: false,
            rownumbers: true, //行号           
            queryParams: {
                operate: 'List'
            }
        });

        function date(value, row, index) {
            var timestamp = value;
            var date = new Date(parseInt(timestamp.replace("/Date(", "").replace(")/", ""), 10));
            Y = date.getFullYear() + '-';
            M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
            D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' ';
            h = (date.getHours() < 10 ? '0' + (date.getHours()) : date.getHours()) + ':';
            m = (date.getMinutes() < 10 ? '0' + (date.getMinutes()) : date.getMinutes()) + ':';
            s = (date.getSeconds() < 10 ? '0' + (date.getSeconds()) : date.getSeconds());
            //var NewDtime = Y + M + D + h + m + s;
            var NewDtime = Y + M + D;
            return NewDtime;
        }


        var editIndex = undefined;
        function endEditing() {
            if (editIndex == undefined) { return true }
            if ($('#tbFriendLink').datagrid('validateRow', editIndex)) {

                $('#tbFriendLink').datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }

        function onClickRow(index) {
            if (editIndex != index) {
                if (endEditing()) {
                    $('#tbFriendLink').datagrid('selectRow', index)
							.datagrid('beginEdit', index);
                    editIndex = index;
                } else {
                    $('#tbFriendLink').datagrid('selectRow', editIndex);
                }
            }
        }

        function append() {
            if (endEditing()) {
                $('#tbFriendLink').datagrid('appendRow', { IsView: '展示' });
                editIndex = $('#tbFriendLink').datagrid('getRows').length - 1;
                $('#tbFriendLink').datagrid('selectRow', editIndex)
						.datagrid('beginEdit', editIndex);
            }
        }

        function removeit() {
            if (editIndex == undefined) { return }
            $('#tbFriendLink').datagrid('cancelEdit', editIndex)
					.datagrid('deleteRow', editIndex);
            editIndex = undefined;
        }

        function accept() {
            if (endEditing()) {
                if ($('#tbFriendLink').datagrid('getChanges').length) {
                    //                    var inserted = $('#tbFriendLink').datagrid('getChanges', "inserted");
                    //                    var deleted = $('#tbFriendLink').datagrid('getChanges', "deleted");
                    var updated = $('#tbFriendLink').datagrid('getChanges', "updated");

                    var effectRow = new Object();

                    //                    if (inserted.length) {
                    //                        effectRow["inserted"] = JSON.stringify(inserted);
                    //                    }
                    //                    if (deleted.length) {
                    //                        effectRow["deleted"] = JSON.stringify(deleted);
                    //                    }
                    if (updated.length) {
                        effectRow["updated"] = JSON.stringify(updated);
                    }
                    $.post("sgzdOperate.ashx", effectRow, function (rsp) {
                        if (rsp.statu) {
                            alert(rsp.Message);
                            $('#tbFriendLink').datagrid('acceptChanges');
                        } else {
                            alert(rsp.Message);
                        }
                    }, "JSON").error(function () {
                        $.messager.alert("提示", "提交错误了！");
                    });
                }
            }
        }

        function reject() {
            $('#tbFriendLink').datagrid('rejectChanges');
            editIndex = undefined;
        }

        function getChanges() {
            var rows = $('#tbFriendLink').datagrid('getChanges');
            alert(rows.length + ' rows are changed!');
        }

        function Search() {
            var Name = document.getElementById("Name").value;
            //var LinkUrl = document.getElementById("LinkUrl").value;
            $('#tbFriendLink').datagrid({
                url: 'sgzd.ashx',
                queryParams: {
                    Name: Name
                    //LinkUrl: LinkUrl,                   
                }
            })
        }

        function Add() {
            var rows = $('#tbFriendLink').datagrid('getSelections');
            var effectRow = new Object();
            effectRow["Add"] = JSON.stringify(rows);
            effectRow["operate"] = "Add";
            if (rows.length >= 1) {
                $.post("../databydx/GetProDataByBIMdx.ashx", effectRow, function (rsp) {
                    if (rsp) {
                        alert("下发成功");
                        $('#tbFriendLink').datagrid('reload');
                    } else {
                        alert(rsp.Message);
                    }
                }, "JSON").error(function () {
                    $.messager.alert("提示", "下发失败！");
                });
            } else {
                alert('请选择一条数据！');
            }
        }
    </script>
</body>
</html>
