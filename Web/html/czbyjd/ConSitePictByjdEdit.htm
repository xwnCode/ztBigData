<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../easyui/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../easyui/icon.css" rel="stylesheet" type="text/css" />
    <script src="../easyui/jquery.min.js" type="text/javascript"></script>
    <script src="../easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../easyui/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <style type="text/css">
        .tdleft
        {
            width: 35px;
            border-right: 1px solid #C1DAD7;
            border-bottom: 1px solid #C1DAD7;
            background: #F5FAFA;
            font-size: 12px;
            color: #4f6b72;
            font-weight: bold;
            line-height: 25px;
            text-align: right;
            padding-right: 10px;
        }
        .tdright
        {
            width: 170px;
            margin-left: 10px;
            border-right: 1px solid #C1DAD7;
            border-bottom: 1px solid #C1DAD7;
            background: #fff;
            font-size: 12px;
            color: #28474F;
            line-height: 25px;
            text-align: left;
            padding-left: 10px;
        }
    </style>
</head>
<body style="font-size: 12px; background-color: #ffffff;">
    <form id="frmData" method="post">
    <div class="easyui-layout">
        <table cellpadding="0px" cellspacing="0px" style="margin: 0px auto; width: 900px;
            height: 750px; border: 1px solid #C1DAD7">
            <tr>
                <td colspan="9" style="background: #F5FAFA; height: 1px; border-bottom: 1px solid #C1DAD7;
                    text-align: center">
                    <label style="text-align: center; font-weight: bold; font-size: 15px;">
                        施工现场进度图</label>
                </td>
            </tr>
            <tr height="40">
                <td class="tdleft">
                    施工内容:
                </td>
                <td class="tdright">
                    <input id="name" name="name" style="width: 500px; border: none;" />
                    <!-- <textarea id="sgnr" name="sgnr"  style="width: 500px; height: 80px;
                        border: none; float: left;"></textarea>-->
                </td>
            </tr>
            <tr>
                <td class="tdleft">
                    施工图片:
                </td>
                <td colspan="6" class="tdright">
                    <input name="icon" id="pfile" type="file" value="" onchange="show(this)" />
                    <img src="" id="pic" height="500px" /><br />   
                </td>
            </tr>
            <tr>
                <td class="tdleft" colspan="6" style="height: 5px">
                    <input type="button" onclick="SaveData()" value="保 存" style="float: right; margin-right: 20px;
                        width: 65px; height: 25px; color: #28474F; background-color: #C1DAD7;" />
                </td>
            </tr>
        </table>
    </div>
    </form>
    <script type="text/javascript">
        //获取跳转信息
        (function ($) {
            $.getUrlParam = function (name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return unescape(r[2]);
                return null;
            }
        })(jQuery);
        var Ids = $.getUrlParam('Id');
//        var names = $.getUrlParam('name');
//        var images = $.getUrlParam('by1');

//        if (names != "" && names != null) {
//            $("#name").val(names);
//            document.getElementById("pic").src = images;
//        }

        $.ajax({
            type: "POST",
            url: "../../databyjd/ConSitePictByjd.ashx",
            dataType: 'json',
            data: { Id: Ids, oper: "get" },
            error: function (request) {
                //alert("保存失败");
            },
            success: function (data) {
                //alert("保存成功");
                //var json = JSON.parse(data);
                $("#name").val(data.name);
                document.getElementById("pic").src = 'data:image/png;base64,' + arrayBufferToBase64(data.image);
            }
        });

        function arrayBufferToBase64(buffer) {
            var binary = '';
            var bytes = new Uint8Array(buffer);
            var len = bytes.byteLength;
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function SaveData() {
            var name = $("#name").val();
            var files = $("#pfile").get(0).files;
            var pic = document.getElementById("pic").src;
            if (name == "" || name == null) {
                alert("请填写图片内容");
                return false;
            }
            if (files.length == 0) {
                alert("请选择图片");
                return false;
            }
            $.ajax({
                type: "POST",
                url: "../../databyjd/ConSitePictByjd.ashx",
                dataType: 'json',
                data: { Id: Ids, name: name, pic: pic, oper: "update" },
                error: function (request) {
                    alert("保存失败");
                },
                success: function (data) {
                    alert("保存成功");
                }
            });
        }

        function show(f) {
            var rd = new FileReader(); //创建文件读取对象
            var files = f.files[0]; //获取file组件中的文件
            rd.readAsDataURL(files); //文件读取装换为base64类型
            rd.onloadend = function (e) {
                //alert(this.result);
                //加载完毕之后获取结果赋值给img
                document.getElementById("pic").src = this.result;
            }
        }
    </script>
</body>
</html>
