<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../easyui/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../easyui/icon.css" rel="stylesheet" type="text/css" />
    <script src="../easyui/jquery.min.js" type="text/javascript"></script>
    <script src="../easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../easyui/easyui-lang-zh_CN.js" type="text/javascript"></script>
</head>
<body>
    <div id="divToolFriendLink">
        <!-- 站点名称：
        <input id="Name" class="textbox" style="width: 180px;" />
        <a id="A2" onclick="Search()" class="easyui-linkbutton" data-options="iconCls:'icon-search'">
            查询</a> &nbsp;&nbsp;&nbsp;&nbsp;-->
        <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add'"
            onclick="append()">添加</a> <a href="javascript:void(0)" class="easyui-linkbutton"
                data-options="iconCls:'icon-remove'" onclick="removeit()">移除</a> <a href="javascript:void(0)"
                    class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="accept()">
                    保存</a>
    </div>
    <table id="tbFriendLink">
        <thead>
            <tr>
                <th data-options="field:'Id',width:180" hidden="true">
                   Id
                </th>
                <th data-options="field:'name',editor:'text',width:280">
                    施工内容
                </th>
                <th data-options="field:'image',width:280,formatter: pic">
                    图片
                </th>
                <!--<th data-options="field:'by1',width:280,formatter: add">
                    上传图片
                </th>-->
            </tr>
        </thead>
    </table>
    <script type="text/javascript">
        $('#tbFriendLink').datagrid({
            iconCls: 'icon-edit', //图标 
            singleSelect: true, //是否单选 
            toolbar: '#divToolFriendLink',
            nowrap: false,
            striped: true,
            border: true,
            collapsible: false, //是否可折叠的        
            //fitColumns:true,       
            url: '../../databyjd/ConSitePictByjds.ashx',
            remoteSort: false,
            onClickRow: onClickRow, //是否可编辑    
            queryParams: {
                oper: "op"
            }
        });

        function pic(value, row, index) {

            return "<img src='' id='pic" + index + "'  />  <input type='file' onchange='show(this," + index + ")' />";
        }

//        function pic(value, row, index) {

//            return "<img src='' id='pic" + index + "'  />";
//        }

//        function add(value, row, index) {

//            return "<input type='file' onchange='show(this," + index + ")' />";
//        }

        function show(f, index) {
            var rd = new FileReader(); //创建文件读取对象
            var files = f.files[0]; //获取file组件中的文件
            rd.readAsDataURL(files); //文件读取装换为base64类型
            rd.onloadend = function (e) {
                //alert(this.result);
                //加载完毕之后获取结果赋值给img
                //                document.getElementById("pic").src = this.result;
                document.getElementById("pic" + index + "").src = this.result;
            }
        }

        var editIndex = undefined;
        function endEditing() {
            if (editIndex == undefined) { return true }
            if ($('#tbFriendLink').datagrid('validateRow', editIndex)) {

                $('#tbFriendLink').datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }

        function onClickRow(index) {
            if (editIndex != index) {
                if (endEditing()) {
                    $('#tbFriendLink').datagrid('selectRow', index)
							.datagrid('beginEdit', index);
                    editIndex = index;
                } else {
                    $('#tbFriendLink').datagrid('selectRow', editIndex);
                }
            }
        }

        function append() {
            if (endEditing()) {
                $('#tbFriendLink').datagrid('appendRow', { IsView: '展示' });
                editIndex = $('#tbFriendLink').datagrid('getRows').length - 1;
                $('#tbFriendLink').datagrid('selectRow', editIndex)
						.datagrid('beginEdit', editIndex);
            }
        }

        function removeit() {
            if (editIndex == undefined) { return }
            $('#tbFriendLink').datagrid('cancelEdit', editIndex)
					.datagrid('deleteRow', editIndex);
            editIndex = undefined;
        }

        function accept() {
            if (endEditing()) {
                if ($('#tbFriendLink').datagrid('getChanges').length) {
                    var inserted = $('#tbFriendLink').datagrid('getChanges', "inserted");
                    var deleted = $('#tbFriendLink').datagrid('getChanges', "deleted");
                    var updated = $('#tbFriendLink').datagrid('getChanges', "updated");

                    var effectRow = new Object();

                    if (inserted.length) {
                        effectRow["inserted"] = JSON.stringify(inserted);
                    }
                    if (deleted.length) {
                        effectRow["deleted"] = JSON.stringify(deleted);
                    }
                    if (updated.length) {
                        effectRow["updated"] = JSON.stringify(updated);
                    }
                    $.post("../../databyjd/ConSitePictByjds.ashx", effectRow, function (rsp) {
                        if (rsp.statu) {
                            alert(rsp.Message);
                            $('#tbFriendLink').datagrid('acceptChanges');
                            $('#tbFriendLink').datagrid('reload');
                        } else {
                            alert(rsp.Message);
                        }
                    }, "JSON").error(function () {
                        $.messager.alert("提示", "提交错误了！");
                    });
                }
            }
        }

        function reject() {
            $('#tbFriendLink').datagrid('rejectChanges');
            editIndex = undefined;
        }

        function getChanges() {
            var rows = $('#tbFriendLink').datagrid('getChanges');
            alert(rows.length + ' rows are changed!');
        }

        function Search() {
            var Name = document.getElementById("Name").value;
            //var LinkUrl = document.getElementById("LinkUrl").value;
            $('#tbFriendLink').datagrid({
                url: 'sgzd.ashx',
                queryParams: {
                    Name: Name
                    //LinkUrl: LinkUrl,                   
                }
            })
        }
    </script>
</body>
</html>
